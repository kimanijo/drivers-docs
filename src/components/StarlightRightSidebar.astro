---
import yaml from 'js-yaml';
import { fileURLToPath } from 'node:url';
import path from 'node:path';
import { existsSync, readFileSync, readdirSync } from 'node:fs'; // Added readdirSync
import TableOfContents from '@astrojs/starlight/components/TableOfContents.astro';
import { slugify } from '../utils/slugify';

const currentPath = Astro.url.pathname;
let driverInfo = {};
let driverManufacturerDisplay = 'N/A'; // Variable to hold manufacturer for display
let driverId = '';
let yamlPath = '';

// Extract driverId from the current URL path
// Example: /drivers/general/driver-a/ -> drivers/general/driver-a
if (currentPath.startsWith('/drivers/')) {
  // Remove '/drivers/' prefix and trailing slash
  driverId = currentPath.substring('/drivers/'.length).replace(/\/$/, '');
  
  const driverIdParts = driverId.split('/');
  const driverCategorySlug = slugify(driverIdParts[0]); // e.g., 'mounts'
  const driverManufacturerSlug = slugify(driverIdParts[1]); // e.g., 'sky-watcher'
  const driverSlug = slugify(driverIdParts[2]); // e.g., 'eqmod'

  // Find the actual cased directory name for the category
  const baseContentDirPath = path.resolve(process.cwd(), `src/content/docs/drivers`);
  let actualCategoryDirName = driverCategorySlug;

  if (existsSync(baseContentDirPath)) {
    const categoryDirs = readdirSync(baseContentDirPath, { withFileTypes: true })
      .filter(dirent => dirent.isDirectory())
      .map(dirent => slugify(dirent.name));

    const foundCategoryDir = categoryDirs.find(dir => dir === driverCategorySlug);
    if (foundCategoryDir) {
      actualCategoryDirName = foundCategoryDir;
    } else {
      console.warn(`StarlightRightSidebar: Actual category directory not found for slug: ${driverCategorySlug}`);
    }
  }

  // Find the actual cased directory name for the manufacturer
  const categoryContentDirPath = path.resolve(process.cwd(), `src/content/docs/drivers/${actualCategoryDirName}`);
  let actualManufacturerDirName = driverManufacturerSlug;

  if (existsSync(categoryContentDirPath)) {
    const manufacturerDirs = readdirSync(categoryContentDirPath, { withFileTypes: true })
      .filter(dirent => dirent.isDirectory())
      .map(dirent => slugify(dirent.name));

    const foundManufacturerDir = manufacturerDirs.find(dir => dir === driverManufacturerSlug);
    if (foundManufacturerDir) {
      actualManufacturerDirName = foundManufacturerDir;
    } else {
      console.warn(`StarlightRightSidebar: Actual manufacturer directory not found for slug: ${driverManufacturerSlug}`);
    }
  }

  const contentDirPath = path.resolve(process.cwd(), `src/content/docs/drivers/${actualCategoryDirName}/${actualManufacturerDirName}`);
  
  if (existsSync(contentDirPath)) {
    try {
      const filesInDir = readdirSync(contentDirPath);
      const yamlFileName = `${driverSlug}.yaml`;
      const yamlFile = filesInDir.find(file => slugify(file) === slugify(yamlFileName));

      if (yamlFile) {
        yamlPath = path.resolve(contentDirPath, yamlFile);
        const fileContents = readFileSync(yamlPath, 'utf8');
        driverInfo = yaml.load(fileContents);

        // Extract manufacturer for display, handling both casings
        if (driverInfo && typeof driverInfo === 'object') {
          if ('manufacturer' in driverInfo) {
            driverManufacturerDisplay = driverInfo.manufacturer;
          } else if ('Manufacturer' in driverInfo) {
            driverManufacturerDisplay = driverInfo.Manufacturer;
          }
        }
      } else {
        // console.warn(`StarlightRightSidebar: YAML file not found for driver ${driverId} in ${contentDirPath}`); // Removed debug log
      }
    } catch (e) {
      console.error(`StarlightRightSidebar: Error processing YAML for ${driverId}:`, e);
    }
  } else {
    // console.warn(`StarlightRightSidebar: Content directory not found for driver ${driverId}: ${contentDirPath}`); // Removed debug log
  }
}
---

<aside class="starlight-right-sidebar">
  <h2 class="starlight__on-this-page">Driver Information</h2>
  {Object.entries(driverInfo).length > 0 ? (
    <ul>
      <li><strong>Manufacturer:</strong> {driverManufacturerDisplay}</li>
      {Object.entries(driverInfo)
        .filter(([key]) => key.toLowerCase() !== 'manufacturer') // Filter out both casings
        .map(([key, value]) => (
        <li><strong>{key}:</strong> {value}</li>
      ))}
    </ul>
  ) : (
    <p>No driver information available.</p>
  )}

  <hr class="starlight-sidebar-separator" />

  <TableOfContents />
</aside>

<style>
  .starlight-right-sidebar {
    padding: 1rem;
    border-left: 1px solid var(--sl-color-gray-5);
    margin-left: 1.5rem;
  }
  .starlight-right-sidebar-title {
    font-size: 1.2em;
    margin-bottom: 1rem;
  }
  .starlight-right-sidebar ul {
    list-style: none;
    padding: 0;
  }
  .starlight-right-sidebar li {
    margin-bottom: 0.5rem;
  }
</style>
