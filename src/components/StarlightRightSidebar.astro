---
import yaml from "js-yaml";
import path from "node:path";
import { existsSync, readFileSync } from "node:fs";
import { Image } from "astro:assets";
import TableOfContents from "@astrojs/starlight/components/TableOfContents.astro";
import { slugify } from "../utils/slugify";

const currentPath = Astro.url.pathname;
let driverInfo: Record<string, any> = {};
let driverManufacturerDisplay = "N/A";
let driverId = "";
let yamlPath = "";
let driverImagePath = "";
let driverImageExists = false;
let driverWebsite = "";

// Extract driverId from the current URL path
// Example: /mounts/sky-watcher/eqmod/ -> mounts/sky-watcher/eqmod
if (currentPath.startsWith("/")) {
  // Remove leading slash and trailing slash
  driverId = currentPath.substring(1).replace(/\/$/, "");

  const driverIdParts = driverId.split("/");

  // Only process if we have a full driver path (category/manufacturer/driver)
  if (driverIdParts.length === 3) {
    const driverCategorySlug = slugify(driverIdParts[0]);
    const driverManufacturerSlug = slugify(driverIdParts[1]);
    const driverSlug = slugify(driverIdParts[2]);

    const contentDirPath = path.resolve(
      process.cwd(),
      `src/content/docs/${driverCategorySlug}/${driverManufacturerSlug}`,
    );

    if (existsSync(contentDirPath)) {
      try {
        const yamlFileName = `${driverSlug}.yaml`;
        const potentialYamlPath = path.resolve(contentDirPath, yamlFileName);

        if (existsSync(potentialYamlPath)) {
          yamlPath = potentialYamlPath;
          const fileContents = readFileSync(yamlPath, "utf8");
          driverInfo = yaml.load(fileContents) as Record<string, any>;

          // Extract manufacturer for display
          if (driverInfo && typeof driverInfo === "object") {
            if (driverInfo.manufacturer_name) {
              driverManufacturerDisplay =
                driverInfo.manufacturer_name as string;
            } else if (driverInfo.manufacturer) {
              driverManufacturerDisplay = driverInfo.manufacturer as string;
            }
            if (driverInfo.website) {
              driverWebsite = driverInfo.website as string;
              // Ensure the website URL is absolute
              if (
                !driverWebsite.startsWith("http://") &&
                !driverWebsite.startsWith("https://")
              ) {
                driverWebsite = `https://${driverWebsite}`;
              }
            }
          }

          // Construct image path and check existence
          const imageFileName = `${driverSlug}.webp`;
          const imageDirPath = path.resolve(
            process.cwd(),
            `public/images/${driverCategorySlug}/${driverManufacturerSlug}`,
          );
          const potentialImagePath = path.resolve(imageDirPath, imageFileName);

          if (existsSync(potentialImagePath)) {
            driverImagePath = `/images/${driverCategorySlug}/${driverManufacturerSlug}/${imageFileName}`;
            driverImageExists = true;
          }
        }
      } catch (e) {
        console.error(
          `StarlightRightSidebar: Error processing YAML for ${driverId}:`,
          e,
        );
      }
    }
  }
}
---

<aside class="starlight-right-sidebar">
  {
    driverImageExists && driverWebsite && (
      <a
        href={driverWebsite}
        target="_blank"
        rel="noopener noreferrer"
        class="driver-thumbnail-link"
      >
        <Image
          src={driverImagePath}
          alt={`${driverInfo.driver_name || "Driver"} Thumbnail`}
          width={320}
          height={180}
          class="driver-thumbnail"
        />
      </a>
    )
  }

  {
    Object.entries(driverInfo).length > 0 ? (
      <div class="driver-info-container">
        <div class="info-row">
          <div class="info-label">Manufacturer</div>
          <div class="info-value">{driverManufacturerDisplay}</div>
        </div>
        {Object.entries(driverInfo)
          .filter(
            ([key]) =>
              key.toLowerCase() !== "manufacturer" &&
              key.toLowerCase() !== "manufacturer_name" &&
              key.toLowerCase() !== "category_name" &&
              key.toLowerCase() !== "driver_name" &&
              key.toLowerCase() !== "website",
          )
          .map(([key, value]) => (
            <div class="info-row">
              <div class="info-label">
                {key
                  .split("_")
                  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                  .join(" ")}
              </div>
              <div class="info-value">{String(value)}</div>
            </div>
          ))}
      </div>
    ) : (
      <p class="no-info">No driver information available.</p>
    )
  }

  <hr class="starlight-sidebar-separator" />

  <TableOfContents />
</aside>

<style>
  .starlight-right-sidebar {
    display: flex;
    flex-direction: column;
    padding: 1rem;
    border-left: 1px solid var(--sl-color-gray-5);
    margin-left: 1.5rem;
    width: max-content;
  }

  .driver-thumbnail-link {
    display: block;
    margin-bottom: 1.5rem;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s ease;
  }

  .driver-thumbnail-link:hover {
    transform: translateY(-3px);
  }

  .driver-thumbnail {
    display: block;
    width: 100%;
    height: auto;
    object-fit: cover;
  }

  .driver-info-container {
    display: flex;
    flex-direction: column;
    border: 2px solid #383c4a;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    background-color: #23262d;
    max-width: 20rem;
  }

  .info-row {
    display: flex;
    border-bottom: 1px solid #383c4a;
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-row:nth-child(even) {
    background-color: rgba(255, 255, 255, 0.03);
  }

  .info-row:hover {
    background-color: rgba(136, 58, 234, 0.15);
    transition: background-color 0.2s ease;
  }

  .info-label {
    flex-shrink: 0;
    width: 120px;
    padding: 0.875rem 1rem;
    font-weight: 700;
    color: #e1e4e8;
    font-size: 0.875rem;
    border-right: 2px solid #383c4a;
    background-color: rgba(255, 255, 255, 0.02);
  }

  .info-value {
    flex: 1;
    padding: 0.875rem 1rem;
    color: #c9d1d9;
    font-size: 0.875rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
    font-weight: 400;
    min-width: 0;
  }

  .no-info {
    color: var(--sl-color-gray-3);
    font-style: italic;
    padding: 1rem;
    text-align: center;
  }

  .starlight-sidebar-separator {
    border: none;
    border-top: 1px solid var(--sl-color-gray-5);
    margin: 1.5rem 0;
  }
</style>
